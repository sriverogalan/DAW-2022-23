<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PIANO</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald:wght@300&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/styles.css" />
  </head>

  <body class="bg">
    <div class="div-title">
      <h1>Score Finder</h1>
    </div>
    <div class="piano">
      <div class="btn-white" id="do"></div>
      <div class="btn-white" id="re">
        <div class="btn-black" id="do-sust"></div>
      </div>
      <div class="btn-white" id="mi">
        <div class="btn-black" id="re-sust"></div>
      </div>
      <div class="btn-white" id="fa"></div>
      <div class="btn-white" id="sol">
        <div class="btn-black" id="fa-sust"></div>
      </div>
      <div class="btn-white" id="la">
        <div class="btn-black" id="sol-sust"></div>
      </div>
      <div class="btn-white" id="si">
        <div class="btn-black" id="la-sust"></div>
      </div>
      <div class="btn-white" id="do7"></div>
    </div>

    <div class="piano-dev">
      <div class="search-song">
        <h2>CERCANT...</h2>
        <p id="cerca"></p>
        <button class="btn-red" id="borrar">Esborrar</button>
      </div>
      <div class="results">
        <h2>RESULTATS:</h2>
        <div id="resultats"></div>
      </div>
    </div>
  </body>
  <script>
    function Nota(nom) {
      this.nom = nom;
      this.src = `audio/${nom}.mp3`;
    }

    function Piano() {
      this.notes = [
        "do",
        "re",
        "mi",
        "fa",
        "sol",
        "la",
        "si",
        "do-sust",
        "re-sust",
        "fa-sust",
        "sol-sust",
        "la-sust",
        "do7",
      ];
      this.partitures = {
        "La Balanguera": [
          "do",
          "re",
          "mi",
          "fa",
          "fa",
          "sol",
          "la-sust",
          "la-sust",
        ],
        "Happy Birthday": [
          "do",
          "do",
          "re",
          "do",
          "fa",
          "mi",
          "do",
          "do",
          "re",
          "do",
          "sol",
          "fa",
        ],
      };
      this.cerca = [];

      this.init = () => {
        this.assignarTeclesPiano();
        this.borrarCerca();
      };
      this.assignarTeclesPiano = () => {
        for (let i = 0; i < this.notes.length; i++) {
          let nota = this.notes[i];
          let tecla = document
            .querySelector("#" + this.notes[i])
            .addEventListener("click", () => {
              this.sonarTeclaPiano(nota);
              this.cerca.push(nota);
              document.querySelector("#cerca").innerHTML += nota + " ";
              let cerca = new Cerca(this.cerca, this.partitures); //creem un objecte cerca;
              cerca.init();
            });
        }
      };

      this.partituraReproduir = (partitura) => {
          let partituraSeleccionada = this.partitures[partitura]; //no se usa
          let temps = 1000;
          let crono = new Cronometro(temps, partituraSeleccionada).init(); 
      };
      
      this.sonarTeclaPiano = (nota) => {
        let n = new Nota(nota);
        let audio = new Audio(n.src);
        audio.play();
      };

      this.borrarCerca = function () {
        document.querySelector("#borrar").addEventListener("click", () => {
          this.cerca = [];
          document.querySelector("#cerca").innerHTML = "";
          document.querySelector("#resultats").innerHTML = "";
        });
      };
    }

    function Cerca(cerca, partitures) {
      this.partitures = partitures;
      this.cerca = cerca;
      this.init = () => {
        this.cercadorPartitures();
      };

      this.cercadorPartitures = () => {
        document.querySelector("#resultats").innerHTML = "";
        for (let partitura in this.partitures) {
          let partituraString = this.partitures[partitura].join(); // join converteix l'array en string separant els elements amb una coma
          let cercaString = this.cerca.join();
          if (partituraString.includes(cercaString)) {
            // cerca si quolca part del String coincideix amb el que hem escrit
            this.pintaPartitura(partitura); // si coincideix, pintam sa partitura 
          }
        }
      };

      this.pintaPartitura = (partitura) => {
        document.querySelector("#resultats").innerHTML += `
                <div class="r">
                  <div>
                      <h3>${partitura}</h3>
                      <p>Lletra</p>
                  </div>
                  <button name="${partitura}" class="btn-red" onclick="new Piano().partituraReproduir('${partitura}')">Reproduir <br> can√ßo</button>
                </div>
            `;
      }; 
    }

    function Cronometro(tempsInterval, partitura) {
      this.tempsInterval = tempsInterval;
      this.partitura = partitura;  

      this.milisegonsCanso = () => {
        let temps =
        this.tempsInterval * this.partitura.length + this.tempsInterval;
        return temps;
      };

      this.init = () => {
        this.tempsIni = new Date().getTime();
        this.tempsFi = this.tempsIni + this.milisegonsCanso();
        clearInterval(this.interval);
        this.interval = setInterval(() => {
          this.tempsActual = new Date();
          this.tempsActual = this.tempsActual.getTime();
          this.milisegons = this.tempsActual - this.tempsIni;
          this.pintarTempsBoto();
          if (this.tempsActual >= this.tempsFi) {
            clearInterval(this.interval);
          }
        }, 1);
      };
      this.pintarTempsBoto = () => {
        let temps = this.tempsActual - this.tempsIni;
        let hores = Math.floor(temps / 3600000);
        let minuts = Math.floor(temps / 1000 / 60);
        let segons = Math.floor((temps / 1000) % 60);
        let milisegons = Math.floor((temps % 1000) / 10);
        let tempsString = `${hores}:${minuts}:${segons}:${milisegons}`;  
      };
    }

    let piano = new Piano().init();
  </script>
</html>
