<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PIANO</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald:wght@300&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/styles.css" />
  </head>

  <body class="bg">
    <div class="div-title">
      <h1>Score Finder</h1>
    </div>
    <div class="piano">
      <div class="btn-white" id="do"></div>
      <div class="btn-white" id="re">
        <div class="btn-black" id="do-sust"></div>
      </div>
      <div class="btn-white" id="mi">
        <div class="btn-black" id="re-sust"></div>
      </div>
      <div class="btn-white" id="fa"></div>
      <div class="btn-white" id="sol">
        <div class="btn-black" id="fa-sust"></div>
      </div>
      <div class="btn-white" id="la">
        <div class="btn-black" id="sol-sust"></div>
      </div>
      <div class="btn-white" id="si">
        <div class="btn-black" id="la-sust"></div>
      </div>
      <div class="btn-white" id="do7"></div>
    </div>

    <div class="piano-dev">
      <div class="search-song">
        <h2>CERCANT...</h2>
        <p id="cerca"></p>
        <button class="btn-red" onclick="borrarCerca()">Esborrar</button>
      </div>
      <div class="results">
        <h2>RESULTATS:</h2>
        <div id="resultats"></div>
      </div>
    </div>
  </body> 
  <script>
    "use strict";
    const notes = [
      "do",
      "re",
      "mi",
      "fa",
      "sol",
      "la",
      "si",
      "do-sust",
      "re-sust",
      "fa-sust",
      "sol-sust",
      "la-sust",
      "do7",
    ];
    const partitures = {
      "La Balanguera": [
        "do",
        "re",
        "mi",
        "fa",
        "fa",
        "sol",
        "la-sust",
        "la-sust",
      ],
      "Happy Birthday": [
        "do",
        "do",
        "re",
        "do",
        "fa",
        "mi",
        "do",
        "do",
        "re",
        "do",
        "sol",
        "fa",
      ],
      "Sesion Quevedo - Bizarrap": [
        "sol",
        "fa-sust",
        "fa-sust",
        " ",
        "fa-sust",
        "fa-sust",
        "sol",
        "fa",
        "mi",
        "re",
        "fa-sust",
        " ",
        "la",
        "mi",
        " ",
        "do-sust",
        "do-sust",
        "do-sust",
        "do-sust",
        "do-sust",
        "do-sust",
        " ",
        "mi",
        "re",
        "do-sust",
        "mi",
        "re",
        "do-sust",
        "mi",
        "re",
        " ",
        "re",
        "fa-sust",
        "fa-sust",
        "fa-sust",
        "fa-sust",
        " ",
        "sol",
        "fa-sust",
        "mi",
        "sol",
        "fa-sust",
        "mi",
        "sol",
        "fa-sust",
      ],
    };
    let cerca = [];

    function Nota(nom) {
      this.nom = nom;
      this.src = `audio/${nom}.mp3`;
    }

    function sonarTecla(nota) {
      let n = new Nota(nota);
      let audio = new Audio(n.src);
      audio.play();
    }

    function borrarCerca() {
      cerca = [];
      document.querySelector("#cerca").innerHTML = "";
      document.querySelector("#resultats").innerHTML = "";
    }

    function assignarTeclesPiano() {
      /*
      for (let i = 0; i < notes.length; i++) {
        let nota = notes[i];
        let tecla = document
          .querySelector("#" + notes[i])
          .addEventListener("click", () => {
            sonarTecla(nota);
            cerca.push(nota);
            cercadorPartitures();
            document.querySelector("#cerca").innerHTML = cerca;
          });
      }*/ 
      notes.forEach((nota) => {
        let tecla = document
          .querySelector("#" + nota)
          .addEventListener("click", () => {
            sonarTecla(nota);
            cerca.push(nota);
            cercadorPartitures();
            document.querySelector("#cerca").innerHTML = cerca;
          });
      });
    }

    function cercadorPartitures() {
      document.querySelector("#resultats").innerHTML = "";
      /* for (let partitura in partitures) { 
        if (partitures[partitura].join().includes(cerca.join())) { 
          pintaPartitura(partitura);
        }
      } */ 
      Object.keys(partitures).forEach((partitura) => {
        if (partitures[partitura].join().includes(cerca.join())) {
          pintaPartitura(partitura);
        }
      });
    }

    function pintaPartitura(partitura) {
      document.querySelector("#resultats").innerHTML += `
                <div>
                  <div>
                      <h3>${partitura}</h3>
                      <p>Lletra</p>
                  </div>
                      <button name="${partitura}" class="btn-red" onclick="reproduirPartitura('${partitura}')">Reproduir <br> can√ßo</button>
                </div>
            `;
    }

    assignarTeclesPiano();

    function reproduirPartitura(partitura) { 
      let partituraSeleccionada = partitures[partitura];
      let i = 0;
      let interval; 
      let temps = 500;
      let crono = new Cronometro(temps, partitura).init();
      interval = setInterval(() => {
        if (i < partituraSeleccionada.length) {
          sonarTecla(partituraSeleccionada[i]);
          i++;
        } else {
          clearInterval(interval);
        }
      }, temps);
    }

    function Cronometro(tempsInterval, partitura) {
      this.tempsInterval = tempsInterval;
      this.partitura = partitura;

      this.milisegonsCanso = () => {
        let temps =
          tempsInterval * partitures[partitura].length + tempsInterval;
        return temps;
      };

      this.init = () => {
        this.tempsIni = new Date();
        this.tempsIni = this.tempsIni.getTime();
        this.tempsFi = this.tempsIni + this.milisegonsCanso();
        this.tempsActual = this.tempsIni;

        this.interval = setInterval(() => {
          this.tempsActual = new Date();
          this.tempsActual = this.tempsActual.getTime();
          this.milisegons = this.tempsActual - this.tempsIni;
          this.pinta();
          if (this.tempsActual >= this.tempsFi) {
            
            clearInterval(this.interval);
          }
        }, 1);
      };

      this.pinta = () => {
        let temps = this.tempsActual - this.tempsIni;
        let hores = Math.floor(temps / 3600000);
        let minuts = Math.floor(temps / 1000 / 60);
        let segons = Math.floor((temps / 1000) % 60);
        let milisegons = Math.floor((temps % 1000) / 10);
        document.querySelector(
          "[name='" + this.partitura + "']"
        ).innerHTML = ` ${hores}:${minuts}:${segons}.${milisegons}  `;
        console.log(this.partitura);
      };
    }
  </script>
</html>
