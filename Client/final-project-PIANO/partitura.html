<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Partitura</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald:wght@300&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <header>
      <nav>
        <h1 class="logo-name">Score Finder</h1>
      </nav>
    </header>

    <section>
      <form name="formulari" method="dialog">
        <input type="number" name="idpartitura" id="id" hidden />

        <label for="titol">Títol</label>
        <input type="text" name="name" id="titol" />

        <label for="idiomaoriginal">Idioma Original</label>
        <select name="idiomaoriginal" id="idiomaOriginal">
          <option selected disabled>Elige un idioma</option>
        </select>

        <input type="text" name="idiomatraduccio" value="ca" hidden />

        <label for="partituratraduccio">Lletra Original</label>
        <textarea
          name="partituratraduccio"
          id="lletraOriginal"
          cols="10"
          rows="5"
        ></textarea>

        <label for="traduccio">Traducció al català</label>
        <textarea name="traduccio" id="traduccio" cols="10" rows="5"></textarea>

        <input type="submit" id="submit" />
      </form>
      <script type="module">
        "use strict";
        import { GoogleService } from "./js/service/GoogleService.js";
        import { PartituraService } from "./js/service/PartituraService.js"; 

        (async () => {
          const googleService = GoogleService.getInstance();
          const idiomes = await googleService.getIdiomes();

          const idiomaOriginal = document.querySelector("#idiomaOriginal");
          idiomes.forEach((idioma) => {
            const option = document.createElement("option");
            option.value = idioma.id;
            option.textContent = idioma.nom;
            idiomaOriginal.appendChild(option);
          });

          const variablesUrl = window.location.search;
          const urlParams = new URLSearchParams(variablesUrl);
          const id = urlParams.get("id");

          if (id) {
            const partituraService = PartituraService.getInstance();
            const partitura = await partituraService.getPartituraById(id);
            document.querySelector("#id").value = partitura.id;
            document.querySelector("#titol").value = partitura.titol;
            document.querySelector("#idiomaOriginal").value =
              partitura.idiomaOriginal;
            document.querySelector("[name=idiomatraduccio]").value =
              partitura.idiomaTraduccio;
            document.querySelector("#lletraOriginal").value =
              partitura.lletraOriginal;
            document.querySelector("#traduccio").value =
              partitura.lletraTraduccio;
          }
          document
            .querySelector("#submit")
            .addEventListener("click", () => check());
        })();
        const titleCheck = () => {
          const titol = document.querySelector("#titol").value;
          const regex = /\w+\s\w+\s\w+/;
          if (regex.test(titol)) {
            document.querySelector("#titol").style.backgroundColor = "green";
            return true;
          } else {
            document.querySelector("#titol").style.backgroundColor = "red";
            return false;
          }
        };
        const idiomaOriginalCheck = () => {
          const idiomaOriginal =
            document.getElementById("idiomaOriginal").value;
          if (idiomaOriginal != -1) {
            document.querySelector("#idiomaOriginal").style.backgroundColor =
              "green";
            return true;
          } else {
            document.querySelector("#idiomaOriginal").style.backgroundColor =
              "red";
            return false;
          }
        };
        const lletraOriginalCheck = () => {
          // comprobar si no esta vacio
          const lletraOriginal =
            document.querySelector("#lletraOriginal").value;
          if (lletraOriginal != "") {
            document.querySelector("#lletraOriginal").style.backgroundColor =
              "green";
            return true;
          } else {
            document.querySelector("#lletraOriginal").style.backgroundColor =
              "red";
            return false;
          }
        };
        const traduccioCheck = () => {
          const traduccio = document.getElementById("traduccio").value;
          if (traduccio != "") {
            document.querySelector("#traduccio").style.backgroundColor =
              "green";
            return true;
          } else {
            document.querySelector("#traduccio").style.backgroundColor = "red";
            return false;
          }
        };
        const checkAll = () => {
          titleCheck();
          idiomaOriginalCheck();
          lletraOriginalCheck();
          traduccioCheck();
          return (
            titleCheck() &&
            idiomaOriginalCheck() &&
            lletraOriginalCheck() &&
            traduccioCheck()
          );
        };

        const check = () => {
          if (checkAll()) {
            const partituraService = PartituraService.getInstance();
            const a = partituraService.savePartitura(
              document.querySelector("#id").value,
              document.querySelector("#titol").value,
              document.querySelector("#idiomaOriginal").value,
              document.querySelector("[name=idiomatraduccio]").value,
              document.querySelector("#lletraOriginal").value, 
              document.querySelector("#traduccio").value,
              []
            );
            console.log(a);
          }
        };
      </script>
    </section>
  </body>
</html>
